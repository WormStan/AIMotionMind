<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¯®çƒæŠ•ç¯®åŠ¨ä½œåˆ†ææŠ¥å‘Š</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ€ ç¯®çƒæŠ•ç¯®åŠ¨ä½œåˆ†ææŠ¥å‘Š</h1>
            <p>åŸºäº MediaPipe å§¿æ€æ£€æµ‹çš„è¿åŠ¨å­¦åˆ†æ</p>
        </div>

        <!-- ä¸»è¦åˆ†æåŒºåŸŸï¼šå·¦ä¾§è§†é¢‘ï¼Œå³ä¾§å®æ—¶å›¾è¡¨ -->
        <div class="main-analysis">
            <!-- å·¦ä¾§ï¼šè§†é¢‘æ’­æ”¾å™¨ -->
            <div class="video-section">
                <h2>ğŸ“¹ æŠ•ç¯®è§†é¢‘</h2>
                <video id="video-player" controls>
                    <source src="{{ video_path }}" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾ã€‚
                </video>
                
                <div class="video-info">
                    <p><strong>å¸§ç‡:</strong> {{ fps }} FPS</p>
                    <p><strong>æ€»å¸§æ•°:</strong> {{ total_frames }} å¸§</p>
                    <p><strong>æ—¶é•¿:</strong> {{ duration }} ç§’</p>
                </div>
                
                <!-- å½“å‰å¸§æ•°æ®æ˜¾ç¤º -->
                <div id="current-data-display" class="video-info" style="margin-top: 15px;">
                    <h4>å½“å‰å¸§æ•°æ®</h4>
                    <p>ç­‰å¾…è§†é¢‘æ’­æ”¾...</p>
                </div>
            </div>

            <!-- å³ä¾§ï¼šå®æ—¶åŒæ­¥å›¾è¡¨ -->
            <div class="realtime-charts">
                <h2>ğŸ“Š å®æ—¶æ•°æ®æ›²çº¿</h2>
                <p style="color: #666; margin-bottom: 10px;">
                    <small>ğŸ“ çº¢çº¿è¡¨ç¤ºå½“å‰æ’­æ”¾ä½ç½® | è™šçº¿è¡¨ç¤ºå…³é”®å¸§</small>
                </p>
                <div class="chart-container">
                    <canvas id="realtime-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- è¯¦ç»†æ•°æ®å›¾è¡¨åŒºåŸŸ -->
        <div class="detailed-charts">
            <h2>ğŸ“ˆ è¯¦ç»†è¿åŠ¨æ•°æ®åˆ†æ</h2>
            
            <div class="charts-grid">
                <!-- è†å…³èŠ‚è§’åº¦ -->
                <div class="chart-item">
                    <h3>è†å…³èŠ‚è§’åº¦å˜åŒ–</h3>
                    <canvas id="knee-angle-chart" height="250"></canvas>
                </div>

                <!-- è‚˜å…³èŠ‚è§’åº¦ -->
                <div class="chart-item">
                    <h3>è‚˜å…³èŠ‚è§’åº¦å˜åŒ–</h3>
                    <canvas id="elbow-angle-chart" height="250"></canvas>
                </div>

                <!-- è‚©å…³èŠ‚è§’åº¦ -->
                <div class="chart-item">
                    <h3>è‚©å…³èŠ‚è§’åº¦å˜åŒ–</h3>
                    <canvas id="shoulder-angle-chart" height="250"></canvas>
                </div>

                <!-- æ‰‹è…•é€Ÿåº¦ -->
                <div class="chart-item">
                    <h3>æ‰‹è…•é€Ÿåº¦å˜åŒ–</h3>
                    <canvas id="wrist-velocity-chart" height="250"></canvas>
                </div>

                <!-- è‚˜éƒ¨é€Ÿåº¦ -->
                <div class="chart-item">
                    <h3>è‚˜éƒ¨é€Ÿåº¦å˜åŒ–</h3>
                    <canvas id="elbow-velocity-chart" height="250"></canvas>
                </div>

                <!-- èº¯å¹²å€¾æ–œ -->
                <div class="chart-item">
                    <h3>èº¯å¹²å€¾æ–œè§’åº¦å˜åŒ–</h3>
                    <canvas id="trunk-lean-chart" height="250"></canvas>
                </div>
            </div>
        </div>

        <!-- é«˜çº§åˆ†ææŒ‡æ ‡åŒºåŸŸ -->
        <div class="advanced-analysis">
            <h2>ğŸ”¬ é«˜çº§è¿åŠ¨å­¦åˆ†æ</h2>
            
            <div class="analysis-grid">
                <!-- åŠ¨ä½œèŠ‚å¥åˆ†æ -->
                <div class="analysis-card">
                    <h3>â±ï¸ åŠ¨ä½œèŠ‚å¥åˆ†æ</h3>
                    {% if rhythm_analysis %}
                    <div class="metric-item" style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                        <span style="color: #1976d2; font-size: 12px;">
                            ğŸ“ åˆ†æèŒƒå›´: ä»<strong>çƒæœ€ä½ç‚¹</strong>å¼€å§‹
                        </span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">æŠ•ç¯®æ—¶é•¿</span>
                        <span class="metric-value">{{ "%.2f"|format(rhythm_analysis.get('shooting_duration', rhythm_analysis.get('total_duration', 0))) }} ç§’</span>
                        <small class="metric-hint">(ä»çƒæœ€ä½ç‚¹åˆ°ç»“æŸ)</small>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">èŠ‚å¥ä¸€è‡´æ€§</span>
                        <span class="metric-value {% if rhythm_analysis.get('rhythm_consistency', 1) < 0.2 %}good{% elif rhythm_analysis.get('rhythm_consistency', 1) < 0.5 %}medium{% else %}poor{% endif %}">
                            {{ "%.3f"|format(rhythm_analysis.get('rhythm_consistency', 0)) }}
                        </span>
                        <small class="metric-hint">(è¶Šå°è¶Šå¥½)</small>
                    </div>
                    
                    {% if rhythm_analysis.get('key_phases') %}
                    <h4 style="margin-top: 15px; color: #555;">å…³é”®é˜¶æ®µæ—¶é•¿</h4>
                    {% for phase_name, duration in rhythm_analysis['key_phases'].items() %}
                    <div class="metric-item">
                        <span class="metric-label">
                            {% if phase_name == 'preparation' %}é¢„å¤‡é˜¶æ®µ
                            {% elif phase_name == 'power_phase' %}å‘åŠ›é˜¶æ®µ
                            {% elif phase_name == 'follow_through' %}è·Ÿéšé˜¶æ®µ
                            {% else %}{{ phase_name }}{% endif %}
                        </span>
                        <span class="metric-value">{{ "%.2f"|format(duration) }} ç§’</span>
                    </div>
                    {% endfor %}
                    {% endif %}
                    {% else %}
                    <p style="color: #999;">æš‚æ— æ•°æ®</p>
                    {% endif %}
                </div>

                <!-- å…³èŠ‚è¿åŠ¨å¯åŠ¨é¡ºåº -->
                <div class="analysis-card">
                    <h3>âš¡ å‘åŠ›å¯åŠ¨é¡ºåºåˆ†æ</h3>
                    {% if force_sequence %}
                    <div class="metric-item" style="background: #e8f5e9; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                        <span style="color: #2e7d32; font-size: 12px;">
                            ğŸ“ åˆ†æèŒƒå›´: ä»<strong>çƒæœ€ä½ç‚¹</strong>å¼€å§‹ï¼Œæ£€æµ‹ä¸‰ä¸ªå…³é”®éƒ¨ä½çš„å‘åŠ›å¯åŠ¨æ—¶æœº
                        </span>
                    </div>
                    
                    {% if force_sequence.get('pattern_analysis') %}
                    {% set pattern = force_sequence['pattern_analysis'] %}
                    
                    <!-- å‘åŠ›å¯åŠ¨é¡ºåºå¯è§†åŒ– -->
                    <div style="background: #f9fbe7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #827717;">
                        <h4 style="margin: 0 0 10px 0; color: #827717; font-size: 14px;">å‘åŠ›å¯åŠ¨é¡ºåº</h4>
                        <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; font-weight: bold;">
                            {% if pattern.get('initiation_order') %}
                                {% for part in pattern['initiation_order'] %}
                                    <span style="background: {% if part == 'lower' %}#4caf50{% elif part == 'hip' %}#ff9800{% else %}#2196f3{% endif %}; 
                                                 color: white; padding: 8px 16px; border-radius: 20px;">
                                        {% if part == 'lower' %}ä¸‹è‚¢
                                        {% elif part == 'hip' %}é«‹éƒ¨
                                        {% elif part == 'upper' %}ä¸Šè‚¢
                                        {% endif %}
                                    </span>
                                    {% if not loop.last %}
                                        <span style="color: #666; font-size: 20px;">â†’</span>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span style="color: #999;">é¡ºåºæœªæ£€æµ‹åˆ°</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- å„éƒ¨ä½å¯åŠ¨æ—¶åˆ» -->
                    {% if pattern.get('key_parts') %}
                    <div class="metric-item">
                        <span class="metric-label">ä¸‹è‚¢å¯åŠ¨</span>
                        <span class="metric-value">ç¬¬ {{ pattern['key_parts']['lower'] }} å¸§</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">é«‹éƒ¨å¯åŠ¨</span>
                        <span class="metric-value">ç¬¬ {{ pattern['key_parts']['hip'] }} å¸§</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ä¸Šè‚¢å¯åŠ¨</span>
                        <span class="metric-value">ç¬¬ {{ pattern['key_parts']['upper'] }} å¸§</span>
                    </div>
                    {% endif %}
                    
                    {% if force_sequence.get('actual_sequence') %}
                    <h4 style="margin-top: 15px; color: #555;">å®é™…è¿åŠ¨å¯åŠ¨é¡ºåº</h4>
                    <div class="force-chain">
                        {% for joint in force_sequence['actual_sequence'] %}
                        <div class="chain-item">
                            {% if joint == 'right_ankle' %}è„šè¸
                            {% elif joint == 'right_knee' %}è†ç›–
                            {% elif joint == 'right_hip' %}é«‹éƒ¨
                            {% elif joint == 'right_shoulder' %}è‚©éƒ¨
                            {% elif joint == 'right_elbow' %}è‚˜éƒ¨
                            {% elif joint == 'right_wrist' %}æ‰‹è…•
                            {% else %}{{ joint.replace('right_', '').replace('_', ' ').title() }}{% endif %}
                            {% if not loop.last %}<span class="arrow">â†’</span>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    <div class="metric-item small" style="margin-top: 8px;">
                        <span style="font-size: 12px; color: #666;">
                            ğŸ’¡ è¿åŠ¨é˜ˆå€¼: {{ force_sequence.get('movement_threshold', 20) }} åƒç´ /å¸§
                        </span>
                    </div>
                    {% endif %}
                    
                    <!-- å…³é”®å…³èŠ‚å¯¹å¯åŠ¨é¡ºåºåˆ†æ -->
                    {% if force_sequence.get('joint_pairs_analysis') %}
                    <h4 style="margin-top: 20px; color: #555; border-bottom: 2px solid #e0e0e0; padding-bottom: 5px;">
                        ğŸ¯ å…³é”®å…³èŠ‚å¯¹å¯åŠ¨é¡ºåº
                    </h4>
                    <div style="background: #fafafa; padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                        <small style="color: #666;">
                            ğŸ’¡ åˆ†æåŒä¸€è‚¢ä½“å†…ç›¸é‚»å…³èŠ‚çš„å¯åŠ¨å…ˆåï¼Œåˆ¤æ–­å‘åŠ›ä¼ é€’æ–¹å‘
                        </small>
                    </div>
                    
                    {% set pairs = force_sequence['joint_pairs_analysis']['pairs'] %}
                    {% for pair in pairs %}
                    <div style="background: white; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: #333; font-size: 14px;">
                                {{ pair['pair_name'] }}
                            </span>
                        </div>
                        
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="flex: 1;">
                                <div style="font-size: 16px; font-weight: bold; color: #555;">
                                    {{ pair['sequence'] }}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                {% if pair['frame_diff'] is not none %}
                                <div style="font-size: 13px; color: #666;">
                                    æ—¶é—´å·®: <strong>{{ "%.3f"|format(pair['time_diff_seconds']) }}ç§’</strong>
                                </div>
                                <div style="font-size: 12px; color: #999;">
                                    ({{ pair['frame_diff'] }}å¸§)
                                </div>
                                {% else %}
                                <div style="font-size: 13px; color: #999;">æ•°æ®ç¼ºå¤±</div>
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if pair['frame_diff'] is not none %}
                        <div style="font-size: 12px; color: #777;">
                            {{ pair['joint1_cn'] }}: ç¬¬{{ pair['joint1_frame'] }}å¸§ | 
                            {{ pair['joint2_cn'] }}: ç¬¬{{ pair['joint2_frame'] }}å¸§
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <div class="metric-item" style="background: #e3f2fd; padding: 10px; border-radius: 4px; margin-top: 10px;">
                        <span style="font-size: 13px; color: #1565c0;">
                            ğŸ“Š æ€»ç»“: {{ force_sequence['joint_pairs_analysis']['summary'] }}
                        </span>
                    </div>
                    {% endif %}
                    {% else %}
                    <p style="color: #999;">æš‚æ— æ•°æ®</p>
                    {% endif %}
                </div>

                <!-- èƒ½é‡ä¼ é€’æ•ˆç‡ -->
                <div class="analysis-card">
                    <h3>ğŸ’ª åŠ›é‡ä¼ é€’åè°ƒæ€§</h3>
                    {% if energy_transfer %}
                    <div class="metric-item" style="background: #fff3e0; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                        <span style="color: #e65100; font-size: 12px;">
                            ğŸ“ åˆ†æèŒƒå›´: ä»<strong>çƒæœ€ä½ç‚¹</strong>åˆ°å‡ºæ‰‹ï¼Œè§‚å¯Ÿä¸‹è‚¢â†’ä¸Šè‚¢çš„åŠ›é‡ä¼ é€’
                        </span>
                    </div>
                    
                    <h4 style="margin-top: 15px; color: #555;">é€Ÿåº¦åˆ†æ</h4>
                    <div class="metric-item">
                        <span class="metric-label">ä¸‹è‚¢å³°å€¼é€Ÿåº¦</span>
                        <span class="metric-value">{{ "%.1f"|format(energy_transfer.get('lower_body_peak_velocity', 0)) }}</span>
                        <small class="metric-hint">ç¬¬{{ energy_transfer.get('lower_peak_frame', 0) }}å¸§</small>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">ä¸Šè‚¢å³°å€¼é€Ÿåº¦</span>
                        <span class="metric-value">{{ "%.1f"|format(energy_transfer.get('upper_body_peak_velocity', 0)) }}</span>
                        <small class="metric-hint">ç¬¬{{ energy_transfer.get('upper_peak_frame', 0) }}å¸§</small>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">é€Ÿåº¦æ”¾å¤§æ¯”</span>
                        <span class="metric-value">{{ "%.2f"|format(energy_transfer.get('velocity_ratio', 0)) }}x</span>
                    </div>
                    
                    <h4 style="margin-top: 15px; color: #555;">æ—¶åºåˆ†æ</h4>
                    <div class="metric-item">
                        <span class="metric-label">å³°å€¼æ—¶é—´å·®</span>
                        <span class="metric-value">{{ energy_transfer.get('timing_difference', 0) }} å¸§</span>
                        <small class="metric-hint">{{ energy_transfer.get('transfer_timing', '') }}</small>
                    </div>
                    {% else %}
                    <!-- æ—§ç‰ˆæœ¬æ•°æ®å…¼å®¹ -->
                    <div class="metric-item">
                        <span class="metric-label">ä¼ é€’æ•ˆç‡</span>
                        <span class="metric-value">{{ "%.1f"|format(energy_transfer.get('efficiency', 0) * 100) }}%</span>
                    </div>
                    {% endif %}
                    {% else %}
                    <p style="color: #999;">æš‚æ— æ•°æ®</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- å…³é”®å¸§åˆ†æåŒºåŸŸ -->
        <div class="keyframes-section">
            <h2>ğŸ¯ å…³é”®å¸§åˆ†æ</h2>
            
            <div class="keyframes-grid">
                {% for kf_name, kf_data in keyframes.items() %}
                <div class="keyframe-card">
                    <img src="keyframes/keyframe_{{ kf_name }}.jpg" alt="{{ kf_data['description'] }}">
                    <div class="keyframe-info">
                        <h3>{{ kf_data['description'] }}</h3>
                        <p><strong>æ—¶é—´:</strong> {{ "%.2f"|format(kf_data['frame_data']['timestamp']) }} ç§’</p>
                        <p><strong>å¸§å·:</strong> {{ kf_data['index'] }}</p>
                        
                        <div class="keyframe-data">
                            <h4>å…³èŠ‚è§’åº¦æ•°æ®</h4>
                            {% if kf_data['frame_data'].get('angles') %}
                                {% for angle_name, angle_value in kf_data['frame_data']['angles'].items() %}
                                <div class="data-item">
                                    <span class="data-label">{{ angle_name_map.get(angle_name, angle_name) }}</span>
                                    <span class="data-value">{{ "%.1f"|format(angle_value) }}Â°</span>
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- é¡µè„š -->
        <div class="footer">
            <p>Â© 2025 ç¯®çƒæŠ•ç¯®åˆ†æç³»ç»Ÿ | åŸºäº MediaPipe & OpenCV</p>
            <p>ç”Ÿæˆæ—¶é—´: {{ generation_time }}</p>
        </div>
    </div>

    <!-- åŠ è½½åˆ†ææ•°æ® -->
    <script>
        // ä»åç«¯æ³¨å…¥çš„åˆ†ææ•°æ®
        const analysisData = {{ analysis_data_json | safe }};
    </script>

    <!-- åŠ è½½è‡ªå®šä¹‰è„šæœ¬ -->
    <script src="assets/js/video_sync.js"></script>
    <script src="assets/js/charts.js"></script>

    <!-- åˆå§‹åŒ– -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–è§†é¢‘åŒæ­¥æ§åˆ¶å™¨
            const video = document.getElementById('video-player');
            const syncController = new VideoSyncController(video, analysisData);
            
            // åˆå§‹åŒ–å›¾è¡¨ç®¡ç†å™¨
            const chartsManager = new ChartsManager(analysisData, syncController);
            
            // åˆ›å»ºå®æ—¶å›¾è¡¨
            chartsManager.createRealtimeChart('realtime-chart');
            
            // åˆ›å»ºè¯¦ç»†å›¾è¡¨
            chartsManager.createAngleChart('knee-angle-chart', 'knee_angle');
            chartsManager.createAngleChart('elbow-angle-chart', 'elbow_angle');
            chartsManager.createAngleChart('shoulder-angle-chart', 'shoulder_angle');
            chartsManager.createAngleChart('trunk-lean-chart', 'trunk_lean');
            
            chartsManager.createVelocityChart('wrist-velocity-chart', 'right_wrist');
            chartsManager.createVelocityChart('elbow-velocity-chart', 'right_elbow');
            
            console.log('Basketball shot analysis report initialized!');
        });
    </script>
</body>
</html>
